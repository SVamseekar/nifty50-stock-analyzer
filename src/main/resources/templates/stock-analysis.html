<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:insert="fragments/header.html"></head>
<body>
<div th:replace="fragments/common.html ::common ('Stock Analysis')"></div>

<div>
    <!-- Advanced Filter Form -->
    <div class="main-form">
        <h3><i class="fas fa-filter"></i> Advanced Filters</h3>
        <form action="/stock-analysis" method="get">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                <div>
                    <label for="symbol">Symbol:</label>
                    <select name="symbol" id="symbol">
                        <option value="">üîπ All Stocks</option>
                        <option th:each="stock : ${nifty50Stocks}" 
                                th:value="${stock}" 
                                th:selected="${stock.equals(selectedSymbol)}"
                                th:text="${stock}">RELIANCE</option>
                    </select>
                </div>
                
                <div>
                    <label for="fromDate">From Date:</label>
                    <input type="date" name="fromDate" id="fromDate" th:value="${fromDate}"/>
                </div>
                
                <div>
                    <label for="toDate">To Date:</label>
                    <input type="date" name="toDate" id="toDate" th:value="${toDate}"/>
                </div>
                
                <div>
                    <label for="minPercentage">Min % Change:</label>
                    <input type="number" step="0.01" name="minPercentage" id="minPercentage" 
                           th:value="${minPercentage}" placeholder="e.g., 2.5"/>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                <div>
                    <label for="maxPercentage">Max % Change:</label>
                    <input type="number" step="0.01" name="maxPercentage" id="maxPercentage" 
                           th:value="${maxPercentage}" placeholder="e.g., -2.5"/>
                </div>
                
                <div>
                    <label for="minVolume">Min Volume:</label>
                    <input type="number" name="minVolume" id="minVolume" 
                           th:value="${minVolume}" placeholder="e.g., 1000000"/>
                </div>
                
                <div>
                    <label for="sortBy">Sort By:</label>
                    <select name="sortBy" id="sortBy">
                        <option value="date" th:selected="${sortBy == 'date'}">Date (Latest First)</option>
                        <option value="percentageChange" th:selected="${sortBy == 'percentageChange'}">% Change (Highest First)</option>
                        <option value="volume" th:selected="${sortBy == 'volume'}">Volume (Highest First)</option>
                        <option value="symbol" th:selected="${sortBy == 'symbol'}">Symbol (A-Z)</option>
                    </select>
                </div>
                
                <div>
                    <label for="limit">Max Results:</label>
                    <select name="limit" id="limit">
                        <option value="100" th:selected="${limit == 100}">100</option>
                        <option value="500" th:selected="${limit == 500}">500</option>
                        <option value="1000" th:selected="${limit == 1000}">1000</option>
                        <option value="5000" th:selected="${limit == 5000}">5000</option>
                        <option value="0" th:selected="${limit == 0}">All</option>
                    </select>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; align-items: center;">
                <button type="submit"><i class="fas fa-search"></i> Apply Filters</button>
                <a href="/stock-analysis"><button type="button"><i class="fas fa-redo"></i> Reset</button></a>
                <button type="button" onclick="exportTableToCSV('analysis-table', 'stock_analysis.csv')">
                    <i class="fas fa-download"></i> Export CSV
                </button>
                <span style="margin-left: 20px; color: #6c757d;">
                    <i class="fas fa-info-circle"></i> 
                    Showing <strong th:text="${#lists.size(stockData)}">0</strong> results
                </span>
            </div>
        </form>
    </div>

    <!-- Quick Filter Buttons -->
    <div class="quick-actions">
        <h3><i class="fas fa-lightning-bolt"></i> Quick Filters</h3>
        <div>
            <a href="/stock-analysis?minPercentage=5"><button type="button">üìà Gains > 5%</button></a>
            <a href="/stock-analysis?maxPercentage=-5"><button type="button">üìâ Losses > 5%</button></a>
            <a href="/stock-analysis?minPercentage=10"><button type="button">üöÄ Big Gains > 10%</button></a>
            <a href="/stock-analysis?maxPercentage=-10"><button type="button">üí• Big Losses > 10%</button></a>
            <a href="/stock-analysis?fromDate=[[${#temporals.format(#temporals.createDate(#temporals.year(#temporals.createNow()), #temporals.monthValue(#temporals.createNow()), 1), 'yyyy-MM-dd')}]]"><button type="button">üìÖ This Month</button></a>
            <a href="/stock-analysis?fromDate=[[${#temporals.format(#temporals.createDate(#temporals.year(#temporals.createNow()), 1, 1), 'yyyy-MM-dd')}]]"><button type="button">üóìÔ∏è This Year</button></a>
        </div>
    </div>

    <!-- Analysis Results Table -->
    <div style="margin-top: 30px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3><i class="fas fa-table"></i> Analysis Results</h3>
            <div>
                <button type="button" onclick="clearAllFilters('analysis-table')" style="font-size: 12px;">
                    <i class="fas fa-eraser"></i> Clear Filters
                </button>
                <button type="button" onclick="toggleHighlights()" style="font-size: 12px;">
                    <i class="fas fa-highlighter"></i> Toggle Highlights
                </button>
            </div>
        </div>
        
        <table class="filterable" id="analysis-table">
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Date</th>
                    <th>Open Price</th>
                    <th>High Price</th>
                    <th>Low Price</th>
                    <th>Close Price</th>
                    <th>% Change</th>
                    <th>Price Change</th>
                    <th>Volume</th>
                    <th>MA 100</th>
                    <th>MA 200</th>
                    <th>Signal 100</th>
                    <th>Signal 200</th>
                    <th>Golden Cross</th>
                    <th>Trading Signal</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="data : ${stockData}">
                    <td>
                        <strong th:text="${data.symbol}">RELIANCE</strong>
                    </td>
                    <td th:text="${#temporals.format(data.date, 'dd-MM-yyyy')}">01-01-2025</td>
                    <td th:text="${#numbers.formatDecimal(data.openPrice, 1, 2)}">2500.00</td>
                    <td th:text="${#numbers.formatDecimal(data.highPrice, 1, 2)}">2550.00</td>
                    <td th:text="${#numbers.formatDecimal(data.lowPrice, 1, 2)}">2480.00</td>
                    <td th:text="${#numbers.formatDecimal(data.closingPrice, 1, 2)}">2530.00</td>
                    <td th:class="${data.percentageChange.doubleValue() > 0 ? 'positive-change' : (data.percentageChange.doubleValue() < 0 ? 'negative-change' : 'neutral-change')}"
                        th:text="${(data.percentageChange.doubleValue() >= 0 ? '+' : '') + #numbers.formatDecimal(data.percentageChange, 1, 2) + '%'}">+2.45%</td>
                    <td th:class="${data.priceChange != null && data.priceChange.doubleValue() > 0 ? 'positive-change' : (data.priceChange != null && data.priceChange.doubleValue() < 0 ? 'negative-change' : 'neutral-change')}"
                        th:text="${data.priceChange != null ? ((data.priceChange.doubleValue() >= 0 ? '+' : '') + #numbers.formatDecimal(data.priceChange, 1, 2)) : 'N/A'}">+30.00</td>
                    <td th:text="${data.volume != null ? #numbers.formatInteger(data.volume, 0, 'COMMA') : 'N/A'}">1,234,567</td>
                    <td th:text="${data.movingAverage100Day != null ? #numbers.formatDecimal(data.movingAverage100Day, 1, 2) : 'N/A'}">2480.50</td>
                    <td th:text="${data.movingAverage200Day != null ? #numbers.formatDecimal(data.movingAverage200Day, 1, 2) : 'N/A'}">2450.75</td>
                    <td>
                        <span th:if="${data.maSignal100 != null}" 
                              th:class="'signal-' + ${data.maSignal100.toLowerCase()}" 
                              th:text="${data.maSignal100}">BUY</span>
                        <span th:if="${data.maSignal100 == null}">N/A</span>
                    </td>
                    <td>
                        <span th:if="${data.maSignal200 != null}" 
                              th:class="'signal-' + ${data.maSignal200.toLowerCase()}" 
                              th:text="${data.maSignal200}">BUY</span>
                        <span th:if="${data.maSignal200 == null}">N/A</span>
                    </td>
                    <td>
                        <span th:if="${data.goldenCross != null}" 
                              th:class="${data.goldenCross == 'GOLDEN_CROSS' ? 'signal-strong-buy' : (data.goldenCross == 'DEATH_CROSS' ? 'signal-strong-sell' : 'signal-hold')}" 
                              th:text="${data.goldenCross}">GOLDEN_CROSS</span>
                        <span th:if="${data.goldenCross == null}">N/A</span>
                    </td>
                    <td>
                        <span th:if="${data.tradingSignalStrength != null}" 
                              th:class="'signal-' + ${data.tradingSignalStrength.toLowerCase().replace('_', '-')}" 
                              th:text="${data.tradingSignalStrength}">STRONG_BUY</span>
                        <span th:if="${data.tradingSignalStrength == null}">N/A</span>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(stockData)}">
                    <td colspan="15" style="text-align: center; color: #6c757d; font-style: italic; padding: 30px;">
                        <i class="fas fa-search"></i><br>
                        No data found for the selected filters.<br>
                        Try adjusting your filter criteria or fetch new data from the dashboard.
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Summary Statistics -->
    <div th:if="${!#lists.isEmpty(stockData)}" style="margin-top: 30px;">
        <div class="quick-actions">
            <h3><i class="fas fa-chart-bar"></i> Summary Statistics</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                <div><strong>Total Records:</strong> <span th:text="${#lists.size(stockData)}">0</span></div>
                <div><strong>Positive Changes:</strong> <span class="positive-change" th:text="${positiveChanges ?: '0'}">0</span></div>
                <div><strong>Negative Changes:</strong> <span class="negative-change" th:text="${negativeChanges ?: '0'}">0</span></div>
                <div><strong>Average % Change:</strong> <span th:text="${avgPercentageChange != null ? #numbers.formatDecimal(avgPercentageChange, 1, 2) + '%' : 'N/A'}">N/A</span></div>
                <div><strong>Unique Stocks:</strong> <span th:text="${uniqueStocks ?: '0'}">0</span></div>
                <div><strong>Date Range:</strong> <span th:text="${dateRange ?: 'N/A'}">N/A</span></div>
            </div>
        </div>
    </div>
</div>

<div th:replace="fragments/common.html ::footer"></div>

<!-- Analysis-specific JavaScript -->
<script th:replace="fragments/common.html ::clock-script"></script>
<script>
let highlightsEnabled = true;

function toggleHighlights() {
    highlightsEnabled = !highlightsEnabled;
    const table = document.getElementById('analysis-table');
    if (highlightsEnabled) {
        table.classList.remove('no-highlights');
        highlightPercentageChanges();
    } else {
        table.classList.add('no-highlights');
        // Remove highlight classes
        const cells = table.querySelectorAll('.positive-change, .negative-change, .neutral-change');
        cells.forEach(cell => {
            cell.classList.remove('positive-change', 'negative-change', 'neutral-change');
        });
    }
}

// Auto-set date inputs to reasonable defaults
document.addEventListener('DOMContentLoaded', function() {
    const fromDateInput = document.getElementById('fromDate');
    const toDateInput = document.getElementById('toDate');
    
    if (!fromDateInput.value) {
        const sixMonthsAgo = new Date();
        sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
        fromDateInput.value = sixMonthsAgo.toISOString().split('T')[0];
    }
    
    if (!toDateInput.value) {
        const today = new Date();
        toDateInput.value = today.toISOString().split('T')[0];
    }
});

// Add CSS for no-highlights mode
const style = document.createElement('style');
style.textContent = `
    .no-highlights .positive-change,
    .no-highlights .negative-change,
    .no-highlights .neutral-change {
        color: inherit !important;
        background-color: inherit !important;
    }
`;
document.head.appendChild(style);
</script>

</body>
</html>